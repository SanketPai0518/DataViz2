<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Who’s Online: Internet Users by Country (2021)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fafbff; }
    header { padding:14px 18px; font-weight:700; }
    #vis { max-width: 1100px; margin: 0 auto 18px; padding: 0 12px; }
    footer { max-width:1100px; margin: 0 auto 24px; padding: 0 12px; font-size:12px; color:#555; }
  </style>
</head>
<body>
<header>Who’s Online: Internet Users (% of Population) by Country, 2021</header>
<div id="vis"></div>
<footer>Local data only: <code>data/countries.geojson</code> + <code>data/internet_users_2021.csv</code></footer>

<script>
const spec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 1000, "height": 560,
  "projection": {"type": "equalEarth"},
  "layer": [
    { "data": {"sphere": true}, "mark": {"type": "geoshape", "fill": "#eaf3ff"} },
    { "data": {"graticule": {"step": [30, 30]}},
      "mark": {"type": "geoshape", "stroke": "#bcd0e3", "strokeWidth": 0.6, "filled": false} },

    {
      "data": { "url": "data/countries.geojson", "format": { "type": "json", "property": "features" } },
      "mark": { "type": "geoshape", "fill": "#eef2f7" },
      "encoding": { "shape": { "field": "geometry", "type": "geojson" } }
    },

    {
      "data": {
        "url": "data/countries.geojson",
        "format": { "type": "json", "property": "features" }
      },
      "transform": [
        {
          "calculate":
            "upper((isValid(datum.properties['ISO3166-1-Alpha-3']) ? datum.properties['ISO3166-1-Alpha-3'] :" +
            " (isValid(datum.properties.ISO_A3) ? datum.properties.ISO_A3 :" +
            " (isValid(datum.properties.ADM0_A3) ? datum.properties.ADM0_A3 : datum.properties.SOV_A3))))",
          "as": "iso_raw"
        },
        { "calculate": "replace(datum.iso_raw, ' ', '')", "as": "iso_clean" },
        { "filter": "datum.iso_clean && datum.iso_clean != '-99' && length(datum.iso_clean) == 3" },
        { "calculate": "datum.iso_clean", "as": "iso3" },
        {
          "lookup": "iso3",
          "from": {
            "data": { "url": "data/internet_users_2021.csv" },
            "key": "Code",
            "fields": ["Entity","Value"]
          }
        },
        { "filter": "isValid(datum.Value)" }
      ],
      "mark": { "type": "geoshape" },
      "encoding": {
        "shape": { "field": "geometry", "type": "geojson" },
        "color": {
          "field": "Value",
          "type": "quantitative",
          "title": "Internet users (%), 2021",
          "scale": { "scheme": "blues", "domain": [0, 100] }
        },
        "tooltip": [
          { "field": "Entity", "title": "Country" },
          { "field": "iso3", "title": "ISO3" },
          { "field": "Value", "title": "% online", "format": ".1f" }
        ]
      }
    },

    {
      "data": { "url": "data/countries.geojson", "format": { "type": "json", "property": "features" } },
      "mark": { "type": "geoshape", "filled": false, "stroke": "#ffffff", "strokeWidth": 0.5 },
      "encoding": { "shape": { "field": "geometry", "type": "geojson" } }
    }
  ],
  "config": {
    "view": { "stroke": null, "continuousWidth": 1000, "continuousHeight": 560 },
    "legend": { "orient": "right", "titleFontWeight": "bold" },
    "background": "#ffffff",
    "padding": 0
  }
};

vegaEmbed("#vis", spec, { actions: false });
</script>
</body>
</html>
