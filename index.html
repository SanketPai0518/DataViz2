<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CO₂ emissions per capita (latest year)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { padding:16px 20px; font-weight:600; }
    #vis { max-width: 1100px; margin: 0 auto 24px; padding: 0 12px; }
    footer { max-width:1100px; margin: 0 auto 24px; padding: 0 12px; font-size:12px; color:#555; }
  </style>
</head>
<body>
<header>CO₂ emissions per capita (tonnes/person — latest available year)</header>
<div id="vis"></div>
<footer>
  Data: Our World in Data (co₂ per capita), world.geo.json (ISO-3 codes). No local files needed.
</footer>

<script>
const spec = {
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 1000, "height": 560,
  "projection": {"type":"equalEarth"},
  /* Use a GeoJSON that already has ISO-3 codes as the feature id */
  "data": {
    "url": "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json",
    "format": {"type":"geojson"}
  },
  "transform": [
    /* id in this file is ISO-3 (e.g., 'AUS', 'USA'). Copy to 'iso3' for clarity. */
    {"calculate": "datum.id", "as": "iso3"},

    /* Join OWID CO₂-per-capita (Entity, Code, Year, <value-col>) on ISO-3 code */
    {
      "lookup": "iso3",
      "from": {
        "data": {
          "url": "https://ourworldindata.org/grapher/co-emissions-per-capita.csv"
        },
        "key": "Code",
        "fields": ["Entity","Year",
          /* OWID sometimes uses slightly different column titles across exports.
             Pick the first non-null among common variants and put it in 'co2pc'. */
          "CO₂ emissions (tonnes per person)",
          "CO2 emissions (tonnes per person)",
          "CO2 emissions (per capita)",
          "co2_per_capita"
        ]
      }
    },

    /* Collapse possible column-name variants into one numeric field 'co2pc' */
    {
      "calculate":
        "isValid(datum['CO₂ emissions (tonnes per person)']) ? datum['CO₂ emissions (tonnes per person)']" +
        ": (isValid(datum['CO2 emissions (tonnes per person)']) ? datum['CO2 emissions (tonnes per person)']" +
        ": (isValid(datum['CO2 emissions (per capita)']) ? datum['CO2 emissions (per capita)']" +
        ": datum['co2_per_capita']))",
      "as": "co2pc"
    },

    /* Keep latest year per country (sort by Year, then take the last) */
    {"window": [{"op":"rank","as":"r"}], "frame":[null,null], "sort":[{"field":"Year","order":"ascending"}], "groupby":["iso3"]},
    {"filter": "datum.r == max(datum.r)"},

    /* Only rows with valid numeric values */
    {"filter": "isValid(datum.co2pc)"}
  ],
  "mark": {"type":"geoshape"},
  "encoding": {
    "color": {
      "field": "co2pc",
      "type": "quantitative",
      "title": "Tonnes CO₂ per person (latest)",
      "scale": {"scheme":"blues"}
    },
    "tooltip": [
      {"field":"Entity","title":"Country"},
      {"field":"Year","type":"temporal","title":"Year"},
      {"field":"co2pc","type":"quantitative","title":"tCO₂ per person","format":".2f"}
    ]
  },
  "config": {
    "view": {"stroke": null},
    "legend": {"orient":"right"},
    "background":"#ffffff"
  }
};

vegaEmbed("#vis", spec, {actions:false});
</script>
</body>
</html>
